<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.0, user-scalable=yes">
    <title>CBTdvd Screensaver</title>
    <!-- Preload with fallbacks -->
    <link rel="preload" href="/assets/cbt-background.webp" as="image" type="image/webp">
    <link rel="preload" href="/assets/cbt-background.png" as="image" type="image/png" onerror="this.onerror=null; this.href='/assets/cbt-background.png'">
    <link rel="preload" href="/assets/cbt-text.webp" as="image" type="image/webp">
    <link rel="preload" href="/assets/cbt-text.png" as="image" type="image/png" onerror="this.onerror=null; this.href='/assets/cbt-text.png'">


    <!-- Open Graph Meta Tags (defer og:image) -->
    <meta property="og:title" content="CBTdvd Screensaver - CBTstreams">
    <meta property="og:description" content="Watch the CBT logo bounce around your screen like a classic DVD screensaver.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cbtland.github.io/CBTdvd/">
    <!-- Defer og:image load -->
    <meta property="og:image" content="javascript:void(0)" data-og-image="/assets/ogimage.webp">

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            font-family: Arial, sans-serif;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            max-height: 100vh;
            max-width: 100vw;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            z-index: 20;
            display: block;
        }

        @media (max-width: 768px) {
            body { transform: scale(0.9); transform-origin: center center; }
            #cbt-container { width: min(200px, 30vw) !important; height: min(80px, 12vh) !important; }
            #stats-display { font-size: 14px !important; top: 10px !important; right: 10px !important; padding: 8px !important; min-width: 160px !important; }
        }

        @media (max-width: 480px) {
            body { transform: scale(0.8); }
            #cbt-container { width: min(160px, 35vw) !important; height: min(65px, 14vh) !important; }
            #stats-display { font-size: 12px !important; padding: 6px !important; min-width: 140px !important; }
        }

        #cbt-container {
            position: absolute;
            width: min(240px, 25vw);
            height: min(100px, 10vh);
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 120px;
            min-height: 50px;
            visibility: hidden; /* Hidden until images load or fallback applied */
        }

        #cbt-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('/assets/cbt-background.webp');
            background-size: cover;
            background-position: center;
            border-radius: 0;
            z-index: 1;
            background-color: #000; /* Fallback color */
        }

        #cbt-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: 0;
            z-index: 2;
            opacity: 0.3;
        }

        #cbt-text {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
            object-fit: contain;
            display: none; /* Hidden until image loads */
        }

        #corner-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            display: none;
        }

        #stats-display {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            display: none;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            min-width: 200px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 11;
            pointer-events: none;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="cbt-container">
        <div id="cbt-background"></div>
        <div id="cbt-overlay"></div>
        <img id="cbt-text" src="/assets/cbt-text.webp" alt="CBT">
    </div>

    <div id="corner-counter">Corner Hits: 0</div>
    <div id="stats-display">
        <div>Corner Hits: <span id="corner-count">0</span></div>
    </div>
    <div id="confetti-container"></div>

    <script>
        const cbtContainer = document.getElementById('cbt-container');
        const cbtBackground = document.getElementById('cbt-background');
        const cbtText = document.getElementById('cbt-text');
        const cbtOverlay = document.getElementById('cbt-overlay');
        const cornerCounter = document.getElementById('corner-counter');
        const confettiContainer = document.getElementById('confetti-container');
        const statsDisplay = document.getElementById('stats-display');
        const cornerCountSpan = document.getElementById('corner-count');
        const loading = document.getElementById('loading');

        let statsVisible = false;
        let x, y, dx, dy;
        let cornerHits = parseInt(localStorage.getItem('cornerHits') || '0', 10);
        let lastCornerTime = Date.now();
        let currentColor = '#ff0000';

        function getRandomColor() {
            const colors = [
                '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
                '#ff8000', '#8000ff', '#0080ff', '#80ff00', '#ff0080', '#8080ff'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getInitialState() {
            const screenWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);
            const screenHeight = Math.min(window.innerHeight, document.documentElement.clientHeight);
            const cbtWidth = Math.max(120, Math.min(240, screenWidth * 0.25));
            const cbtHeight = Math.max(50, Math.min(100, screenHeight * 0.10));

            return {
                x: Math.random() * (screenWidth - cbtWidth),
                y: Math.random() * (screenHeight - cbtHeight),
                dx: (Math.random() > 0.5 ? 1 : -1) * Math.max(2, screenWidth * 0.003),
                dy: (Math.random() > 0.5 ? 1 : -1) * Math.max(2, screenHeight * 0.003),
                cornerHits: cornerHits,
                lastCornerTime: Date.now(),
                currentColor: getRandomColor()
            };
        }

        function updateDisplay() {
            cornerCountSpan.textContent = cornerHits;
            cbtOverlay.style.backgroundColor = currentColor;
        }

        function updatePosition() {
            cbtContainer.style.left = x + 'px';
            cbtContainer.style.top = y + 'px';
        }

        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8000', '#8000ff', '#ffffff', '#ffd700'];
            const shapes = ['circle', 'square', 'triangle'];

            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';

                const spawnSide = Math.random();
                let startX, startY, endX, endY;

                if (spawnSide < 0.6) {
                    startX = Math.random() * 100;
                    startY = -10;
                    endX = startX + (Math.random() - 0.5) * 40;
                    endY = 110;
                } else if (spawnSide < 0.8) {
                    startX = -10;
                    startY = Math.random() * 50;
                    endX = Math.random() * 100 + 50;
                    endY = Math.random() * 50 + 50;
                } else {
                    startX = 110;
                    startY = Math.random() * 50;
                    endX = Math.random() * 50 - 10;
                    endY = Math.random() * 50 + 50;
                }

                confetti.style.left = startX + '%';
                confetti.style.top = startY + '%';

                const color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.backgroundColor = color;

                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                if (shape === 'circle') {
                    confetti.style.borderRadius = '50%';
                } else if (shape === 'triangle') {
                    confetti.style.width = '0';
                    confetti.style.height = '0';
                    confetti.style.backgroundColor = 'transparent';
                    confetti.style.borderLeft = '5px solid transparent';
                    confetti.style.borderRight = '5px solid transparent';
                    confetti.style.borderBottom = `10px solid ${color}`;
                }

                const size = Math.random() * 10 + 3;
                if (shape !== 'triangle') {
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                }

                const duration = Math.random() * 2 + 2.5;
                const delay = Math.random() * 0.8;
                const rotation = Math.random() * 1440 + 360;

                confetti.style.transition = `all ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                confetti.style.transitionDelay = delay + 's';

                confettiContainer.appendChild(confetti);

                setTimeout(() => {
                    confetti.style.left = endX + '%';
                    confetti.style.top = endY + '%';
                    confetti.style.transform = `rotate(${rotation}deg) scale(0.1)`;
                    confetti.style.opacity = '0';
                }, 50);

                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, (duration + delay) * 1000 + 1000);
            }
        }

        function showCornerHit() {
            cornerHits++;
            localStorage.setItem('cornerHits', cornerHits);
            cornerCounter.textContent = `Corner Hits: ${cornerHits}`;
            cornerCountSpan.textContent = cornerHits;
            console.log(`ðŸŽ‰ CORNER HIT #${cornerHits}! Time since last: ${(Date.now() - lastCornerTime) / 1000}s`);
            lastCornerTime = Date.now();
            createConfetti();
        }

        function isCornerHit(newX, newY, screenWidth, screenHeight, cbtWidth, cbtHeight) {
            const tolerance = 5;
            const leftEdge = newX <= tolerance;
            const rightEdge = newX >= screenWidth - cbtWidth - tolerance;
            const topEdge = newY <= tolerance;
            const bottomEdge = newY >= screenHeight - cbtHeight - tolerance;
            return (leftEdge || rightEdge) && (topEdge || bottomEdge);
        }

        let lastFrameTime = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;

        function animate(currentTime = 0) {
            if (currentTime - lastFrameTime < frameInterval) {
                requestAnimationFrame(animate);
                return;
            }
            lastFrameTime = currentTime;

            const screenWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);
            const screenHeight = Math.min(window.innerHeight, document.documentElement.clientHeight);
            const cbtWidth = Math.max(120, Math.min(240, screenWidth * 0.25));
            const cbtHeight = Math.max(50, Math.min(100, screenHeight * 0.10));

            let newX = x + dx;
            let newY = y + dy;
            let hitWall = false;
            let hitCorner = false;

            if (newX + cbtWidth >= screenWidth) {
                newX = screenWidth - cbtWidth;
                dx = -Math.abs(dx);
                hitWall = true;
            } else if (newX <= 0) {
                newX = 0;
                dx = Math.abs(dx);
                hitWall = true;
            }

            if (newY + cbtHeight >= screenHeight) {
                newY = screenHeight - cbtHeight;
                dy = -Math.abs(dy);
                hitWall = true;
            } else if (newY <= 0) {
                newY = 0;
                dy = Math.abs(dy);
                hitWall = true;
            }

            if (hitWall && isCornerHit(newX, newY, screenWidth, screenHeight, cbtWidth, cbtHeight)) {
                hitCorner = true;
                showCornerHit();
            }

            x = newX;
            y = newY;

            if (hitWall) {
                currentColor = getRandomColor();
                cbtOverlay.style.backgroundColor = currentColor;
                if (hitCorner) {
                    cbtOverlay.style.opacity = '0.6';
                    setTimeout(() => {
                        cbtOverlay.style.opacity = '0.3';
                    }, 500);
                }
            }

            updatePosition();
            updateDisplay();
            requestAnimationFrame(animate);
        }

        let currentZoom = 1;

        function adjustMobileZoom() {
            if (window.innerWidth <= 768) {
                const vh = window.innerHeight;
                const vw = window.innerWidth;
                if (vh < 600 || vw < 400) currentZoom = 0.7;
                else if (vh < 700 || vw < 500) currentZoom = 0.8;
                else currentZoom = 0.9;
                document.body.style.transform = `scale(${currentZoom})`;
                document.body.style.transformOrigin = 'center center';
            } else {
                document.body.style.transform = 'scale(1)';
                currentZoom = 1;
            }
        }

        adjustMobileZoom();
        window.addEventListener('resize', adjustMobileZoom);

        document.addEventListener('click', (e) => {
            statsVisible = !statsVisible;
            statsDisplay.style.display = statsVisible ? 'block' : 'none';
        });

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                adjustMobileZoom();
                window.dispatchEvent(new Event('resize'));
            }, 100);
        });

        window.addEventListener('resize', () => {
            const viewportWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);
            const viewportHeight = Math.min(window.innerHeight, document.documentElement.clientHeight);
            let widthPercent = 0.25, heightPercent = 0.10;
            if (viewportWidth <= 768) { widthPercent = 0.30; heightPercent = 0.12; }
            if (viewportWidth <= 480) { widthPercent = 0.35; heightPercent = 0.14; }

            const newWidth = Math.max(120, Math.min(240, viewportWidth * widthPercent));
            const newHeight = Math.max(50, Math.min(100, viewportHeight * heightPercent));

            cbtContainer.style.width = newWidth + 'px';
            cbtContainer.style.height = newHeight + 'px';

            if (x !== null && y !== null) {
                x = Math.min(x, viewportWidth - newWidth);
                y = Math.min(y, viewportHeight - newHeight);
                x = Math.max(x, 0);
                y = Math.max(y, 0);
                updatePosition();
            }
        });

        // Preload and handle image loading
        const images = [
            { webp: '/assets/cbt-background.webp', png: '/assets/cbt-background.png' },
            { webp: '/assets/cbt-text.webp', png: '/assets/cbt-text.png' }
        ];
        let imagesLoaded = 0;

        function preloadImages() {
            images.forEach(({ webp, png }) => {
                const img = new Image();
                img.src = webp;
                img.onload = () => {
                    imagesLoaded++;
                    if (webp === '/assets/cbt-background.webp') cbtBackground.style.backgroundImage = `url(${webp})`;
                    else if (webp === '/assets/cbt-text.webp') {
                        cbtText.src = webp;
                        cbtText.style.display = 'block';
                    }
                    checkLoadComplete();
                };
                img.onerror = () => {
                    console.warn(`WebP failed, trying PNG: ${webp}`);
                    const fallbackImg = new Image();
                    fallbackImg.src = png;
                    fallbackImg.onload = () => {
                        imagesLoaded++;
                        if (png === '/assets/cbt-background.png') cbtBackground.style.backgroundImage = `url(${png})`;
                        else if (png === '/assets/cbt-text.png') {
                            cbtText.src = png;
                            cbtText.style.display = 'block';
                        }
                        checkLoadComplete();
                    };
                    fallbackImg.onerror = () => {
                        console.error(`Both WebP and PNG failed for: ${webp}`);
                        imagesLoaded++; // Increment even on error to avoid hang
                        checkLoadComplete();
                    };
                };
            });
        }

        function checkLoadComplete() {
            if (imagesLoaded === images.length * 2) { // Account for WebP and PNG attempts
                loading.style.display = 'none';
                cbtContainer.style.visibility = 'visible';
            }
        }

        // Initialize and start
        const initialState = getInitialState();
        x = initialState.x;
        y = initialState.y;
        dx = initialState.dx;
        dy = initialState.dy;
        cornerHits = initialState.cornerHits;
        lastCornerTime = initialState.lastCornerTime;
        currentColor = initialState.currentColor;

        cbtContainer.style.width = Math.max(120, Math.min(240, Math.min(window.innerWidth, document.documentElement.clientWidth) * 0.25)) + 'px';
        cbtContainer.style.height = Math.max(50, Math.min(100, Math.min(window.innerHeight, document.documentElement.clientHeight) * 0.10)) + 'px';

        updateDisplay();
        updatePosition();
        preloadImages();
        requestAnimationFrame(animate);
    </script>
